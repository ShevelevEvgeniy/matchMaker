# MatchMaker

Этот проект представляет собой простой сервис матчмейкера, написанный на языке Go. Сервис формирует группы игроков, основываясь на их задержке (latency), уровне навыка (skill) и времени ожидания в очереди.
### *Возможные функции:*
- *POST /users*
  Добавляет игрока в очередь матчмейкера. Запрос должен содержать следующие параметры:
  - name: Имя игрока (строка).
  - skill: Уровень навыка игрока (число с плавающей точкой).
  - latency: Задержка игрока (число с плавающей точкой).
### *База данных:*

*Для хранения данных используется СУБД PostgreSQL. В проекте определена таблица:*
- users - содержит информацию о пользователях, включая идентификатор, время начала ожидания и находиться ли пользователь в поиске.

### *Кэш:*
*Для хранения пользователей которые находяться в поиске вспомогательным инструментом выступает Redis* 
### *Формат входных данных:*

- Для ручки POST /users
  данные принимаются в формате JSON и включают поля:
    ```json
    {
      "users": [
        {
          "name": "user1",
          "Skill": 1.5,
          "Latency": 7.3
        }, 
        {
          "name": "user2",
          "Skill": 5.8,
          "Latency": 6.4
        }
      ]
    }
    ```
### *Формат данных на выходе:*
- Ручка POST /users возвращает статус код в формате JSON (пример удачного добавления):
  ```json
  {
    "status":201
  }
  ```
  
## Окружение

### Требования
- Docker 20.x.x
- Docker Compose 1.29.x
- Go 1.21+

### Переменные окружения

| Параметр                    | Описание                                           | Default             |
|-----------------------------|----------------------------------------------------|---------------------|
| `ENV_TYPE`                  | Режим окружения                                    | `development`       |
| `HTTP_SERVER_PORT `         | Порт для HTTP-сервера                              | `8081`              |
| `HTTP_SERVER_NAME `         | Имя HTTP сервера                                   | `match_maker`       |
| `HTTP_SERVER_TIMEOUT `      | Таймаут запроса к серверу                          | `4s`                |
| `HTTP_SERVER_IDLE_TIMEOUT ` | Таймаут простоя сервера                            | `60s`               |
| `DB_HOST`                   | Хост базы данных                                   | `localhost`         |
| `DB_PORT`                   | Порт базы данных                                   | `5432`              |
| `DB_NAME`                   | Имя базы данных                                    | `match_maker_db`    |
| `DB_USER_NAME`              | Имя пользователя базы данных                       | `user`              |
| `DB_PASSWORD`               | Пароль пользователя базы данных                    | `secret`            |
| `DB_SSL_MODE`               | Режим SSL для базы данных                          | `disable`           |
| `DB_DRIVER_NAME`            | Имя драйвера базы данных                           | `postgres`          |
| `DB_MAX_CONNS`              | Максимальное количество соединений БД              | `20`                |
| `MIGRATION_URL`             | URL для миграций                                   | `file://migrations` |
| `REDIS_NAME`                | Имя инстанса Redis                                 | `match_maker_redis` |
| `REDIS_HOST`                | Хост для подключения к Redis                       | `match_maker_redis` |
| `REDIS_PORT`                | Порт для подключения к Redis                       | `6379`              |
| `REDIS_DB`                  | Номер базы данных в Redis                          | `0`                 |
| `REMAINING_USERS_KEY`       | Ключ в Redis для хранения оставшихся пользователей | `remainig_usesrs`   |
| `GROUP_SIZE`                | Размер групп для формирования                      | `2`                 |
| `BATCH`                     | Размер извлекаемых данных из бд                    | `1000`              |
| `COUNT_WORKERS`             | Колличество воркеров для формирования групп        | `5`                 |
| `DELAY`                     | Время ожидания при отсутствии пользователей        | `5s`                |



## Установка

**PROJECT**

- Создать новую директорию для проекта. В консоли перейти в созданную директорию и написать: git clone https://github.com/ShevelevEvgeniy/matchMaker.git

**DOCKER**

*Сборка:*

Скопировать файл .env.dist и переименовать в .env, настроить параметры окружения cp .env.dist .env
Для развертывания, запустите установку, выполнив команду ниже: make install

*Служебное:*
- make migrate-up - Запуск миграций
- make migrate-down - Откат миграций
- make migrate-create name="$" - Создание новой миграции
- make restart - пересборка контейнера match_maker
- make run-tests - запуск тестов

# Как это работает

### Общий обзор
- GroupFormationHandler - это основной компонент сервиса матчмейкера, 
который отвечает за формирование групп игроков на основе их характеристик,
таких как задержка (latency) и уровень навыка (skill). Этот хэндлер управляет 
процессом выборки игроков из очереди, формированием групп с минимальными различиями 
в характеристиках и обработкой этих групп.

### Компоненты

- Service - интерфейс, который определяет взаимодействие с хранилищем данных.
- Events - интерфейс для обработки сформированных групп.
- zap.Logger - логгер, который используется для записи логов хэндлера.

### Поток выполнения
1. Запуск обработчика (Run):

- При запуске хэндлер начинает с выборки пользователей из базы через функцию selectUsers.
Выполнение метода происходит в отдельной go-рутине 

- После этого запускается несколько горутин для параллельного формирования групп (generateGroups).
Количество этих горутин определяется конфигурационным параметром COUNT_WORKERS.

2. Выборка пользователей (selectUsers):

- В этой функции происходит извлечение пользователей из очереди в базе данных.
Данные при извлечении сортируються по времени начала поиска пользователя.
Размер извлекаемых пачек конфигурируеться параметром GROUP_SIZE.

- Если подходящих пользователей нет, 
происходит ожидание в соответствии с параметром DELAY, после чего попытка повторяется.

- Выбранные пользователи отправляются в канал usersChan для дальнейшей обработки.

3. Генерация групп (generateGroups):

- Получает список пользователей из канала usersChan

- Проверяет наличие пользователей в кэше, если они там присутсвуют, 
то они добавляются к текущему списку пользователей в начало списка.

- Для формирования групп используется метод createGroupsUsingNearestNeighbors, 
который применяет алгоритм поиска ближайших соседей (nearest neighbors).

4. Формирование групп (createGroupsUsingNearestNeighbors):

- Пользователи конвертируются в матрицу координат, где каждая строка представляет собой пользователя, 
а столбцы - его характеристики (например, задержка и уровень навыка).

- Для каждого пользователя, который ещё не был распределён в группу, находится ближайшая группа пользователей.

- Если сформированная группа соответствует требованиям (например, её размер равен GroupSize), 
она фиксируется и передаётся на дальнейшую обработку через events.Handle.

5. Сохранение оставшихся пользователей:

- Если после попыток сформировать группу остаются пользователи, которые не попали ни в одну из групп, 
они сохраняются в кэше для дальнейшей обработки.

## Алгоритм поиска ближайших соседей
- Для каждого пользователя вычисляется евклидово расстояние до всех остальных пользователей.
- Пользователи сортируются по расстоянию, и ближайшие из них добавляются в текущую группу.
- Евклидово расстояние рассчитывается с использованием функции euclideanDistance, 
которая измеряет расстояние между двумя точками в многомерном пространстве.

Если у вас возникли вопросы или проблемы, вы можете связаться со мной по адресу Z_shevelev@mail.ru